<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#9333ea">
    <meta name="description" content="Centralna tablica ogłoszeń dla rodziców - wszystko w jednym miejscu">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TabliCa">
    
    <title>TabliCa Rodzica</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        .active\:scale-98:active {
            transform: scale(0.98);
        }
        
        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .week-nav {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
        }

        .week-nav::-webkit-scrollbar {
            display: none;
        }

        /* Hania - różowy */
        .hania-bg {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        }
        .hania-border {
            border-left: 4px solid #ec4899;
        }
        .hania-text {
            color: #be185d;
        }
        .hania-badge {
            background-color: #fbcfe8;
            color: #9d174d;
        }

        /* Teodor - niebieski */
        .teodor-bg {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        .teodor-border {
            border-left: 4px solid #3b82f6;
        }
        .teodor-text {
            color: #1e40af;
        }
        .teodor-badge {
            background-color: #bfdbfe;
            color: #1e3a8a;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-purple-800 mb-2">📅 TabliCa</h1>
                <p class="text-gray-600">Wspólna tablica rodziny</p>
            </div>

            <div id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input
                            type="email"
                            id="loginEmail"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="twoj@email.com"
                        />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hasło</label>
                        <input
                            type="password"
                            id="loginPassword"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="••••••••"
                        />
                    </div>

                    <button
                        onclick="login()"
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl transition-colors"
                    >
                        🔐 Zaloguj się
                    </button>

                    <div id="loginError" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
                        <p class="font-bold">Błąd logowania</p>
                        <p id="loginErrorMessage"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="hidden">
        <!-- Room Setup Modal -->
        <div id="roomSetupModal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-2xl font-bold text-purple-800 mb-4">👋 Witaj w TabliCy!</h2>
                <p class="text-gray-600 mb-6">Wybierz jak chcesz korzystać z aplikacji:</p>
                
                <div class="space-y-4">
                    <button onclick="createNewRoom()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-xl transition-colors text-left">
                        <div class="text-lg mb-1">🆕 Utwórz nową wspólną tablicę</div>
                        <div class="text-sm opacity-90">Dostaniesz link do udostępnienia</div>
                    </button>

                    <div class="text-center text-gray-500 font-bold">LUB</div>

                    <div class="bg-gray-50 p-4 rounded-xl">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kod rodziny:</label>
                        <input
                            type="text"
                            id="roomCodeInput"
                            placeholder="np. kowalskich2025"
                            class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 mb-3"
                        />
                        <button onclick="joinRoom()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition-colors">
                            ✅ Dołącz do wspólnej tablicy
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Link Modal -->
        <div id="shareLinkModal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-2xl font-bold text-purple-800 mb-4">🎉 Gotowe!</h2>
                <p class="text-gray-600 mb-4">Twoja wspólna tablica została utworzona!</p>
                
                <div class="bg-purple-50 p-4 rounded-xl mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Kod rodziny:</p>
                    <div class="bg-white p-3 rounded-lg font-mono text-lg font-bold text-purple-600 break-all" id="displayRoomCode"></div>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl mb-4">
                    <p class="text-sm font-medium text-gray-700 mb-2">Link do udostępnienia:</p>
                    <div class="bg-white p-3 rounded-lg text-sm text-blue-600 break-all" id="displayShareLink"></div>
                </div>

                <button onclick="copyShareLink()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl transition-colors mb-3">
                    📋 Skopiuj link
                </button>

                <button onclick="closeShareModal()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-xl transition-colors">
                    Zamknij
                </button>

                <p class="text-sm text-gray-500 mt-4">💡 Wyślij ten link drugiej osobie!</p>
            </div>
        </div>

        <div class="min-h-screen bg-gradient-to-br from-purple-50 to-pink-50 pb-24">
            <!-- Header -->
            <div class="sticky top-0 z-50 bg-white shadow-lg">
                <div class="max-w-4xl mx-auto p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex-1">
                            <h1 class="text-2xl md:text-3xl font-bold text-purple-800">📅 TabliCa</h1>
                            <p class="text-xs md:text-sm text-gray-600">Wspólna tablica rodziny</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">Nieprzeczytane</div>
                            <div id="unreadCount" class="text-2xl md:text-3xl font-bold text-purple-600">0</div>
                        </div>
                        <button onclick="showShareInfo()" class="ml-3 bg-purple-100 hover:bg-purple-200 text-purple-600 p-2 rounded-lg transition-colors">
                            <span class="text-xl">👥</span>
                        </button>
                        <button onclick="logout()" class="ml-2 bg-red-100 hover:bg-red-200 text-red-600 p-2 rounded-lg transition-colors" title="Wyloguj">
                            <span class="text-xl">🚪</span>
                        </button>
                    </div>
                    
                    <!-- Week Navigation -->
                    <div class="week-nav">
                        <button onclick="changeWeek(-1)" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg font-bold text-gray-700 whitespace-nowrap">
                            ← Poprzedni
                        </button>
                        <button onclick="changeWeek(0)" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap">
                            Ten tydzień
                        </button>
                        <button onclick="changeWeek(1)" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg font-bold text-gray-700 whitespace-nowrap">
                            Następny →
                        </button>
                    </div>
                    
                    <div id="weekDisplay" class="text-center text-sm text-gray-600 mt-2"></div>
                    <div id="syncStatus" class="text-xs text-center mt-1 text-gray-500"></div>
                </div>
            </div>

            <div class="max-w-4xl mx-auto p-4">
                <!-- Search and Filter -->
                <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                    <div class="space-y-3">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">🔍</span>
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Szukaj..."
                                class="w-full pl-11 pr-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                        </div>

                        <!-- Filter by Child -->
                        <div class="flex gap-2">
                            <button onclick="filterByChild('Wszystkie')" id="filterAll" class="flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-xl transition-colors">
                                Wszystkie
                            </button>
                            <button onclick="filterByChild('Hania')" id="filterHania" class="flex-1 bg-pink-100 text-pink-700 font-bold py-3 px-4 rounded-xl transition-colors">
                                👧 Hania
                            </button>
                            <button onclick="filterByChild('Teodor')" id="filterTeodor" class="flex-1 bg-blue-100 text-blue-700 font-bold py-3 px-4 rounded-xl transition-colors">
                                👦 Teodor
                            </button>
                        </div>
                        
                        <select
                            id="filterCategory"
                            class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                            <option value="Wszystkie">Wszystkie kategorie</option>
                            <option value="Teddy Eddie">🧸 Teddy Eddie</option>
                            <option value="Programowanie">💻 Programowanie</option>
                            <option value="Szkoła">📚 Szkoła</option>
                            <option value="Przedszkole">🎨 Przedszkole</option>
                            <option value="Wycieczki">🚌 Wycieczki</option>
                            <option value="Składki">💰 Składki</option>
                            <option value="Inne">📌 Inne</option>
                        </select>
                    </div>
                </div>

                <!-- Add Form -->
                <div id="addForm" class="bg-white rounded-xl shadow-lg p-5 mb-4 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Nowe ogłoszenie</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dla kogo? *</label>
                            <div class="flex gap-3">
                                <button type="button" onclick="selectChild('Hania')" id="selectHania" class="flex-1 bg-pink-100 text-pink-700 hover:bg-pink-200 font-bold py-3 px-4 rounded-xl transition-colors border-2 border-transparent">
                                    👧 Hania
                                </button>
                                <button type="button" onclick="selectChild('Teodor')" id="selectTeodor" class="flex-1 bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-3 px-4 rounded-xl transition-colors border-2 border-transparent">
                                    👦 Teodor
                                </button>
                            </div>
                            <input type="hidden" id="childInput" value="">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tytuł *</label>
                            <input
                                type="text"
                                id="titleInput"
                                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                                placeholder="np. Zajęcia programowania"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Opis</label>
                            <textarea
                                id="descriptionInput"
                                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                                rows="3"
                                placeholder="Szczegóły..."
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data *</label>
                            <input
                                type="date"
                                id="dateInput"
                                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kategoria</label>
                            <select
                                id="categoryInput"
                                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="Teddy Eddie">🧸 Teddy Eddie</option>
                                <option value="Programowanie">💻 Programowanie</option>
                                <option value="Szkoła">📚 Szkoła</option>
                                <option value="Przedszkole">🎨 Przedszkole</option>
                                <option value="Wycieczki">🚌 Wycieczki</option>
                                <option value="Składki">💰 Składki</option>
                                <option value="Inne">📌 Inne</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priorytet</label>
                            <select
                                id="priorityInput"
                                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="normal">Normalne</option>
                                <option value="high">🔥 Pilne</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Źródło</label>
                            <input
                                type="text"
                                id="sourceInput"
                                class="w-full px-4 py-3 text-lg border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500"
                                placeholder="np. Messenger - pani Ania"
                            />
                        </div>

                        <div class="flex gap-3">
                            <button
                                onclick="addAnnouncement()"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-xl transition-colors text-lg"
                            >
                                Dodaj
                            </button>
                            <button
                                onclick="closeAddForm()"
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-4 px-4 rounded-xl transition-colors text-lg"
                            >
                                Anuluj
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Announcements List -->
                <div id="announcementsList" class="space-y-4"></div>

                <!-- Summary -->
                <div class="mt-6 bg-white rounded-xl shadow-lg p-4">
                    <p id="summary" class="text-center text-gray-600 text-sm md:text-base"></p>
                </div>
            </div>

            <!-- Floating Action Button -->
            <div class="fixed bottom-6 right-6 z-40">
                <button
                    onclick="openAddForm()"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold p-5 rounded-full shadow-2xl transition-all active:scale-95"
                    title="Dodaj ogłoszenie"
                >
                    <span class="text-3xl">➕</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // 🔥🔥🔥 WKLEJ TUTAJ SWOJĄ KONFIGURACJĘ FIREBASE 🔥🔥🔥
        const firebaseConfig = {
            apiKey: "AIzaSyBTs9TkU0KwOiAPdhBJs8mQe6fSrClhOuM",
            authDomain: "tablica-rodzica.firebaseapp.com",
            databaseURL: "https://tablica-rodzica-default-rtdb.firebaseio.com",
            projectId: "tablica-rodzica",
            storageBucket: "tablica-rodzica.firebasestorage.app",
            messagingSenderId: "616878397001",
            appId: "1:616878397001:web:d7cbae0cbf403a9bbd1198"
        };
        // 🔥🔥🔥 KONIEC KONFIGURACJI 🔥🔥🔥

        let db;
        let auth;
        let currentUser = null;
        let currentRoom = null;
        let announcements = [];
        let currentWeekOffset = 0;
        let currentChildFilter = 'Wszystkie';

        // Inicjalizacja Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        auth = firebase.auth();

        // Sprawdź stan logowania
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                checkRoomStatus();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        // Logowanie
        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showLoginError('Wypełnij email i hasło!');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    console.log('Zalogowano!');
                })
                .catch((error) => {
                    console.error('Błąd logowania:', error);
                    let message = 'Nieprawidłowy email lub hasło';
                    if (error.code === 'auth/user-not-found') {
                        message = 'Nie znaleziono użytkownika. Skontaktuj się z administratorem.';
                    } else if (error.code === 'auth/wrong-password') {
                        message = 'Nieprawidłowe hasło';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Nieprawidłowy format email';
                    }
                    showLoginError(message);
                });
        }

        function logout() {
            if (confirm('Czy na pewno chcesz się wylogować?')) {
                auth.signOut();
            }
        }

        function showLoginError(message) {
            document.getElementById('loginError').classList.remove('hidden');
            document.getElementById('loginErrorMessage').textContent = message;
            setTimeout(() => {
                document.getElementById('loginError').classList.add('hidden');
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });

        function updateSyncStatus(message) {
            document.getElementById('syncStatus').textContent = message;
        }

        function checkRoomStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomFromUrl = urlParams.get('room');
            const savedRoom = localStorage.getItem('currentRoom');

            if (roomFromUrl) {
                currentRoom = roomFromUrl;
                localStorage.setItem('currentRoom', currentRoom);
                initRoom();
            } else if (savedRoom) {
                currentRoom = savedRoom;
                initRoom();
            } else {
                showRoomSetupModal();
            }
        }

        function showRoomSetupModal() {
            document.getElementById('roomSetupModal').classList.remove('hidden');
        }

        function createNewRoom() {
            currentRoom = 'room_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('currentRoom', currentRoom);
            document.getElementById('roomSetupModal').classList.add('hidden');
            
            const shareLink = window.location.origin + window.location.pathname + '?room=' + currentRoom;
            document.getElementById('displayRoomCode').textContent = currentRoom;
            document.getElementById('displayShareLink').textContent = shareLink;
            document.getElementById('shareLinkModal').classList.remove('hidden');
            
            initRoom();
        }

        function joinRoom() {
            const input = document.getElementById('roomCodeInput').value.trim();
            if (!input) {
                alert('Wpisz kod rodziny!');
                return;
            }

            if (input.includes('?room=')) {
                const urlParams = new URLSearchParams(input.split('?')[1]);
                currentRoom = urlParams.get('room');
            } else if (input.includes('room_')) {
                currentRoom = input;
            } else {
                currentRoom = 'room_' + input;
            }

            localStorage.setItem('currentRoom', currentRoom);
            document.getElementById('roomSetupModal').classList.add('hidden');
            initRoom();
        }

        function showShareInfo() {
            const shareLink = window.location.origin + window.location.pathname + '?room=' + currentRoom;
            document.getElementById('displayRoomCode').textContent = currentRoom;
            document.getElementById('displayShareLink').textContent = shareLink;
            document.getElementById('shareLinkModal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('shareLinkModal').classList.add('hidden');
        }

        function copyShareLink() {
            const shareLink = window.location.origin + window.location.pathname + '?room=' + currentRoom;
            navigator.clipboard.writeText(shareLink).then(() => {
                alert('Link skopiowany! 📱');
            });
        }

        function initRoom() {
            if (!currentRoom || !db) return;

            const roomRef = db.ref('rooms/' + currentRoom + '/announcements');
            
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                announcements = data ? Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                })) : [];
                renderAnnouncements();
                updateSyncStatus('🟢 Synchronizacja aktywna');
            });

            setupEventListeners();
        }

        function setupEventListeners() {
            setDateInputToToday();
            updateWeekDisplay();
            document.getElementById('searchInput').addEventListener('input', renderAnnouncements);
            document.getElementById('filterCategory').addEventListener('change', renderAnnouncements);
        }

        function setDateInputToToday() {
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
        }

        function getWeekRange(offset) {
            const today = new Date();
            const currentDay = today.getDay() || 7;
            const monday = new Date(today);
            monday.setDate(today.getDate() - currentDay + 1 + (offset * 7));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return { start: monday, end: sunday };
        }

        function changeWeek(offset) {
            currentWeekOffset = offset;
            updateWeekDisplay();
            renderAnnouncements();
        }

        function updateWeekDisplay() {
            const { start, end } = getWeekRange(currentWeekOffset);
            const formatDate = (d) => `${d.getDate()}.${d.getMonth() + 1}`;
            let weekText = `${formatDate(start)} - ${formatDate(end)}`;
            
            if (currentWeekOffset === 0) weekText = '📅 Ten tydzień (' + weekText + ')';
            else if (currentWeekOffset === -1) weekText = '⬅️ Poprzedni tydzień (' + weekText + ')';
            else if (currentWeekOffset === 1) weekText = '➡️ Następny tydzień (' + weekText + ')';
            else weekText = '📆 Tydzień ' + weekText;
            
            document.getElementById('weekDisplay').textContent = weekText;
        }

        function isInWeek(dateString, weekOffset) {
            const date = new Date(dateString);
            const { start, end } = getWeekRange(weekOffset);
            return date >= start && date <= end;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (date.toDateString() === today.toDateString()) return '🔴 DZIŚ';
            if (date.toDateString() === tomorrow.toDateString()) return '🟡 JUTRO';
            
            const days = ['Nie', 'Pon', 'Wt', 'Śr', 'Czw', 'Pt', 'Sob'];
            return `${days[date.getDay()]} ${date.getDate()}.${date.getMonth() + 1}`;
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'Teddy Eddie': '🧸',
                'Programowanie': '💻',
                'Szkoła': '📚',
                'Przedszkole': '🎨',
                'Wycieczki': '🚌',
                'Składki': '💰',
                'Inne': '📌'
            };
            return emojis[category] || '📌';
        }

        function filterByChild(child) {
            currentChildFilter = child;
            
            // Update button styles
            document.getElementById('filterAll').className = child === 'Wszystkie' 
                ? 'flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-xl transition-colors'
                : 'flex-1 bg-gray-100 text-gray-700 font-bold py-3 px-4 rounded-xl transition-colors';
            
            document.getElementById('filterHania').className = child === 'Hania'
                ? 'flex-1 bg-pink-500 text-white font-bold py-3 px-4 rounded-xl transition-colors'
                : 'flex-1 bg-pink-100 text-pink-700 font-bold py-3 px-4 rounded-xl transition-colors';
            
            document.getElementById('filterTeodor').className = child === 'Teodor'
                ? 'flex-1 bg-blue-500 text-white font-bold py-3 px-4 rounded-xl transition-colors'
                : 'flex-1 bg-blue-100 text-blue-700 font-bold py-3 px-4 rounded-xl transition-colors';
            
            renderAnnouncements();
        }

        function selectChild(child) {
            document.getElementById('childInput').value = child;
            
            // Update button styles
            if (child === 'Hania') {
                document.getElementById('selectHania').className = 'flex-1 bg-pink-500 text-white font-bold py-3 px-4 rounded-xl transition-colors border-2 border-pink-600';
                document.getElementById('selectTeodor').className = 'flex-1 bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-3 px-4 rounded-xl transition-colors border-2 border-transparent';
            } else {
                document.getElementById('selectTeodor').className = 'flex-1 bg-blue-500 text-white font-bold py-3 px-4 rounded-xl transition-colors border-2 border-blue-600';
                document.getElementById('selectHania').className = 'flex-1 bg-pink-100 text-pink-700 hover:bg-pink-200 font-bold py-3 px-4 rounded-xl transition-colors border-2 border-transparent';
            }
        }

        function renderAnnouncements() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterCategory = document.getElementById('filterCategory').value;
            
            const filtered = announcements.filter(a => {
                const matchesSearch = a.title.toLowerCase().includes(searchTerm) ||
                                    a.description.toLowerCase().includes(searchTerm);
                const matchesCategory = filterCategory === 'Wszystkie' || a.category === filterCategory;
                const matchesChild = currentChildFilter === 'Wszystkie' || a.child === currentChildFilter;
                const matchesWeek = isInWeek(a.date, currentWeekOffset);
                return matchesSearch && matchesCategory && matchesChild && matchesWeek;
            }).sort((a, b) => {
                if (a.priority === 'high' && b.priority !== 'high') return -1;
                if (b.priority === 'high' && a.priority !== 'high') return 1;
                return new Date(a.date) - new Date(b.date);
            });

            const list = document.getElementById('announcementsList');
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="bg-white rounded-xl shadow-lg p-8 text-center"><p class="text-gray-500 text-lg">Brak ogłoszeń w tym tygodniu</p></div>';
            } else {
                list.innerHTML = filtered.map(a => {
                    const childClass = a.child === 'Hania' ? 'hania' : 'teodor';
                    const childBg = a.child === 'Hania' ? 'hania-bg' : 'teodor-bg';
                    const childBorder = a.child === 'Hania' ? 'hania-border' : 'teodor-border';
                    const childBadge = a.child === 'Hania' ? 'hania-badge' : 'teodor-badge';
                    const childIcon = a.child === 'Hania' ? '👧' : '👦';
                    
                    return `
                    <div class="${childBg} rounded-xl shadow-lg p-5 transition-all active:scale-98 ${a.read ? 'opacity-60' : ''} ${a.priority === 'high' ? 'border-l-4 border-red-500' : childBorder}">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap items-center gap-2 mb-3">
                                    <span class="font-bold text-base md:text-lg ${childClass}-text whitespace-nowrap">${formatDate(a.date)}</span>
                                    <span class="${childBadge} px-3 py-1 rounded-full text-sm font-medium">
                                        ${childIcon} ${a.child}
                                    </span>
                                    <span class="px-3 py-1 bg-white bg-opacity-70 rounded-full text-sm font-medium">
                                        ${getCategoryEmoji(a.category)} ${a.category}
                                    </span>
                                    ${a.priority === 'high' ? '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">🔥 PILNE</span>' : ''}
                                </div>
                                <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-2 break-words">${a.title}</h3>
                                <p class="text-gray-700 mb-3 break-words">${a.description}</p>
                                ${a.source ? `<p class="text-sm text-gray-600 italic">📱 ${a.source}</p>` : ''}
                            </div>
                            <div class="flex flex-col gap-2 flex-shrink-0">
                                <button
                                    onclick="toggleRead('${a.id}')"
                                    class="p-3 rounded-xl transition-colors ${a.read ? 'bg-green-100 text-green-600' : 'bg-white bg-opacity-50 text-gray-600'}"
                                >
                                    <span class="text-xl">${a.read ? '✅' : '⭕'}</span>
                                </button>
                                <button
                                    onclick="deleteAnnouncement('${a.id}')"
                                    class="p-3 rounded-xl bg-red-100 text-red-600 transition-colors"
                                >
                                    <span class="text-xl">✕</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }

            updateSummary();
        }

        function updateSummary() {
            const thisWeek = announcements.filter(a => isInWeek(a.date, currentWeekOffset));
            const filtered = thisWeek.filter(a => currentChildFilter === 'Wszystkie' || a.child === currentChildFilter);
            const unread = filtered.filter(a => !a.read).length;
            
            document.getElementById('unreadCount').textContent = unread;
            
            let summaryText = `<span class="font-bold text-purple-600">${filtered.length}</span> ogłoszeń w tym tygodniu`;
            document.getElementById('summary').innerHTML = summaryText;
        }

        function toggleRead(id) {
            if (db && currentRoom) {
                const announcement = announcements.find(a => a.id === id);
                if (announcement) {
                    db.ref('rooms/' + currentRoom + '/announcements/' + id).update({
                        read: !announcement.read
                    });
                }
            }
        }

        function deleteAnnouncement(id) {
            if (!confirm('Usunąć to ogłoszenie?')) return;
            
            if (db && currentRoom) {
                db.ref('rooms/' + currentRoom + '/announcements/' + id).remove();
            }
        }

        function openAddForm() {
            document.getElementById('addForm').classList.remove('hidden');
            // Reset child selection
            document.getElementById('childInput').value = '';
            document.getElementById('selectHania').className = 'flex-1 bg-pink-100 text-pink-700 hover:bg-pink-200 font-bold py-3 px-4 rounded-xl transition-colors border-2 border-transparent';
            document.getElementById('selectTeodor').className = 'flex-1 bg-blue-100 text-blue-700 hover:bg-blue-200 font-bold py-3 px-4 rounded-xl transition-colors border-2 border-transparent';
        }

        function closeAddForm() {
            document.getElementById('addForm').classList.add('hidden');
            document.getElementById('titleInput').value = '';
            document.getElementById('descriptionInput').value = '';
            setDateInputToToday();
            document.getElementById('categoryInput').value = 'Szkoła';
            document.getElementById('priorityInput').value = 'normal';
            document.getElementById('sourceInput').value = '';
            document.getElementById('childInput').value = '';
        }

        function addAnnouncement() {
            const child = document.getElementById('childInput').value;
            const title = document.getElementById('titleInput').value;
            const description = document.getElementById('descriptionInput').value;
            const date = document.getElementById('dateInput').value;
            const category = document.getElementById('categoryInput').value;
            const priority = document.getElementById('priorityInput').value;
            const source = document.getElementById('sourceInput').value;

            if (!child) {
                alert('Wybierz dla kogo jest ogłoszenie!');
                return;
            }

            if (!title || !date) {
                alert('Wypełnij tytuł i datę!');
                return;
            }

            const announcement = {
                child,
                title,
                description,
                date,
                category,
                priority,
                source,
                read: false,
                createdAt: Date.now()
            };

            if (db && currentRoom) {
                db.ref('rooms/' + currentRoom + '/announcements').push(announcement);
            }
            
            closeAddForm();
        }
    </script>
</body>
</html>
